<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채팅 컨트롤러 테스트</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        button { margin: 5px; padding: 5px 10px; }
        input, textarea { width: 100%; margin-bottom: 10px; }
        #chatMessages { height: 300px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        .my-message { color: blue; text-align: right; }
        .other-message { color: green; text-align: left; }
    </style>
</head>
<body>
<h1>채팅 컨트롤러 테스트</h1>

<div>
    <h2>사용자 ID 설정</h2>
    <input type="text" id="userId" placeholder="사용자 ID를 입력하세요">
</div>

<div>
    <h2>채팅방 생성</h2>
    <button onclick="createChatRoom()">채팅방 생성</button>
</div>

<div>
    <h2>채팅방 목록</h2>
    <button onclick="getLentChatRooms()">빌려준 채팅방 목록</button>
    <button onclick="getBorrowedChatRooms()">빌린 채팅방 목록</button>
    <div id="chatRoomList"></div>
</div>

<div>
    <h2>채팅방 입장</h2>
    <input type="text" id="chatRoomId" placeholder="채팅방 ID를 입력하세요">
    <button onclick="enterChatRoom()">채팅방 입장</button>
</div>

<div>
    <h2>초대 링크로 채팅방 입장</h2>
    <input type="text" id="invitationLink" placeholder="초대 링크를 입력하세요">
    <button onclick="enterChatRoomViaLink()">링크로 입장</button>
</div>

<div>
    <h2>채팅 메시지</h2>
    <div id="chatMessages"></div>
    <textarea id="messageInput" placeholder="메시지를 입력하세요"></textarea>
    <button onclick="sendMessage()">메시지 전송</button>
</div>

<script th:inline="javascript">
    const BASE_URL = /*[[@{/}]]*/ '/';
    const WS_URL = BASE_URL + 'ws';
    let currentChatRoomId = null;
    let stompClient = null;

    function connectWebSocket() {
        const socket = new SockJS(WS_URL);
        stompClient = Stomp.over(socket);

        const headers = {};

        stompClient.connect(headers, function (frame) {
            console.log('연결됨: ' + frame);
            stompClient.subscribe('/user/queue/messages', function (message) {
                const receivedMessage = JSON.parse(message.body);
                displayMessage(receivedMessage);
            });
        }, function (error) {
            console.log('STOMP 오류 ' + error);
        });
    }

    async function makeRequest(url, method = 'GET', body = null) {
        const options = {
            method,
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include'
        };
        if (body) {
            options.body = JSON.stringify(body);
        }
        const response = await fetch(url, options);

        if (!response.ok) {
            throw new Error(`HTTP 오류! 상태: ${response.status}`);
        }
        return await response.json();
    }

    async function createChatRoom() {
        try {
            const result = await makeRequest(BASE_URL + 'ws/api/v1/chat', 'POST');
            alert(`채팅방이 생성되었습니다. 초대 링크: ${result.invitationLink}`);
        } catch (error) {
            console.error('채팅방 생성 오류:', error);
        }
    }

    async function getLentChatRooms() {
        try {
            const rooms = await makeRequest(BASE_URL + 'ws/api/v1/chat/lent');
            displayChatRooms(rooms);
        } catch (error) {
            console.error('빌려준 채팅방 목록 조회 오류:', error);
        }
    }

    async function getBorrowedChatRooms() {
        try {
            const rooms = await makeRequest(BASE_URL + 'ws/api/v1/chat/borrowed');
            displayChatRooms(rooms);
        } catch (error) {
            console.error('빌린 채팅방 목록 조회 오류:', error);
        }
    }

    function displayChatRooms(rooms) {
        const listElement = document.getElementById('chatRoomList');
        listElement.innerHTML = rooms.map(room => `
                <div>
                    <p>방 ID: ${room.id}, 마지막 메시지: ${room.lastMessage}</p>
                </div>
            `).join('');
    }

    async function enterChatRoom() {
        const roomId = document.getElementById('chatRoomId').value;
        try {
            const messages = await makeRequest(BASE_URL + `ws/api/v1/chat/${roomId}/enter`);
            currentChatRoomId = roomId;
            displayMessages(messages);
            subscribeToRoom(roomId);
        } catch (error) {
            console.error('채팅방 입장 오류:', error);
        }
    }

    async function enterChatRoomViaLink() {
        const link = document.getElementById('invitationLink').value;
        try {
            const messages = await makeRequest(BASE_URL + `ws/api/v1/chat/${link}/link/enter`);
            displayMessages(messages);
            if (messages.length > 0) {
                currentChatRoomId = messages[0].chatRoomId;
                subscribeToRoom(currentChatRoomId);
            }
        } catch (error) {
            console.error('초대 링크로 채팅방 입장 오류:', error);
        }
    }

    function subscribeToRoom(roomId) {
        if (stompClient) {
            stompClient.subscribe(`/topic/chat.${roomId}`, function (message) {
                const receivedMessage = JSON.parse(message.body);
                displayMessage(receivedMessage);
            });
        }
    }

    function displayMessages(messages) {
        const chatMessages = document.getElementById('chatMessages');
        // 최신 메시지가 아래로 가도록 그대로 추가
        chatMessages.innerHTML = messages.map(msg => `
                <p class="${msg.senderId === getCurrentUserId() ? 'my-message' : 'other-message'}">
                    <strong>${msg.senderId}:</strong> ${msg.content}
                </p>
            `).join('');
        // 스크롤을 맨 아래로 이동
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function displayMessage(message) {
        const chatMessages = document.getElementById('chatMessages');
        const messageElement = document.createElement('p');
        messageElement.className = message.senderId === getCurrentUserId() ? 'my-message' : 'other-message';
        messageElement.innerHTML = `<strong>${message.senderId}:</strong> ${message.content}`;
        chatMessages.appendChild(messageElement);
        // 새 메시지 추가 후 스크롤을 맨 아래로 이동
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function sendMessage() {
        if (!currentChatRoomId) {
            alert('먼저 채팅방에 입장해주세요.');
            return;
        }
        const messageInput = document.getElementById('messageInput');
        const content = messageInput.value;
        if (!content.trim()) return;

        const userId = getCurrentUserId();
        if (!userId) {
            alert('사용자 ID를 입력해주세요.');
            return;
        }

        if (stompClient) {
            const messageToSend = {
                chatRoomId: currentChatRoomId,
                senderId: userId, // 사용자 ID 추가
                content: content
            };
            stompClient.send("/pub/chat.message", {}, JSON.stringify(messageToSend));
            // 메시지를 화면에 직접 표시하는 부분을 제거하여 중복 방지
            messageInput.value = '';
        } else {
            console.error('WebSocket 연결이 설정되지 않았습니다.');
        }
    }

    function getCurrentUserId() {
        return document.getElementById('userId').value.trim();
    }

    // 페이지 로드 시 WebSocket 연결
    connectWebSocket();
</script>
</body>
</html>
